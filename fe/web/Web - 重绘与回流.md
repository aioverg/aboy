#### Web 重绘与回流

##### 重绘

1. 概念：当元素样式的改变不影响布局时，浏览器将使用重绘对元素进行更新，此时由于只需要 UI 层面的重新像素绘制，因此损耗较少。

2. 发生重绘情况：

   - 改变元素颜色
   - 改变元素背景色
   - ······

3. 重绘流程

   由于没有导致 DOM 几何属性的变化，因此元素的位置信息不需要更新，从而省去布局的过程。流程如下：

   <img src="C:\Users\acer\aioverg\前端\img\044.jpg" style="zoom:80%;" />

   跳过了`生成布局树`和`建图层树`的阶段，直接生成绘制列表，然后继续进行分块、生成位图等后面一系列操作。

##### 回流

1. 概念：又叫重排（layout）。当元素的尺寸、结构或者触发某些属性时，浏览器会重新渲染页面，称为回流。此时，浏览器需要重新经过计算，计算后还需要重新页面布局，因此是较重的操作。

2. 发生回流的情况：

   - 页面初次渲染
   - 浏览器窗口大小改变
   - 元素尺寸/位置/内容发生改变
   - 元素字体大小变化
   - 添加或者删除可见的 DOM 元素
   - 激活 CSS 伪类（:hover……）
   - 调用 `window.getComputedStyle` 方法。
   - more ……

3. 回流过程

   依照上面的渲染流水线，触发回流的时候，如果 DOM 结构发生改变，则重新渲染 DOM 树，然后将后面的流程(包括主线程之外的任务)全部走一遍。

   <img src="C:\Users\acer\aioverg\前端\img\043.jpg" style="zoom:80%;" />

   相当于将解析和合成的过程重新又走了一篇，开销是非常大的。

4. 注意：回流必定会触发重绘，重绘不一定会触发回流。重绘的开销较小，回流的代价较高。

##### 实践意义

- 避免频繁使用 style，而是采用修改class的方式。
- 使用createDocumentFragment进行批量的 DOM 操作。
- 对于 resize、scroll 等进行防抖/节流处理。
- 添加 will-change: tranform ，让渲染引擎为其单独实现一个图层，当这些变换发生时，仅仅只是利用合成线程去处理这些变换，而不牵扯到主线程，大大提高渲染效率。当然这个变化不限于tranform, 任何可以实现合成效果的 CSS 属性都能用will-change来声明。
